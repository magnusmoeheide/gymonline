rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }

    function hasUserDoc() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function role() { return userDoc().role; }
    function gymId() { return userDoc().gymId; }
    function resolvedGymId() {
      return exists(/databases/$(database)/documents/slugs/$(gymId()))
        ? get(/databases/$(database)/documents/slugs/$(gymId())).data.gymId
        : gymId();
    }

    function isSuperAdmin() {
      return isSignedIn() && hasUserDoc() && role() == "SUPER_ADMIN";
    }
    function isSuperAdminToken() {
      return isSignedIn() && request.auth.token.role == "SUPER_ADMIN";
    }

    function isGymAdmin() {
      return isSignedIn() && hasUserDoc()
        && (role() == "GYM_ADMIN" || role() == "SUPER_ADMIN");
    }

    function isStaff() {
      return isSignedIn() && hasUserDoc()
        && (role() == "STAFF" || role() == "GYM_ADMIN" || role() == "SUPER_ADMIN");
    }

    // ✅ SUPER_ADMIN bypasses sameGym checks (needed for simulation)
    function sameGym(data) {
      return isSignedIn() && hasUserDoc()
        && (isSuperAdmin() || data.gymId == gymId());
    }

    function sameGymExisting() {
      return isSignedIn() && hasUserDoc()
        && (isSuperAdmin() || resource.data.gymId == gymId());
    }

    // Slug mapping: clients can read; writes are server-only
    match /slugs/{slug} {
      allow read: if true;
      allow write: if false;
    }

    // Public directory for login gym-picker (no auth needed)
    match /gymsPublic/{id} {
      allow read: if true;
      allow write: if false;
    }

    // Private gyms docs
    match /gyms/{id} {
      allow read: if isSignedIn() && hasUserDoc() && (id == gymId() || isSuperAdmin());
      allow create: if false;
      allow update: if isGymAdmin() && (isSuperAdmin() || id == gymId());
      allow delete: if false;
    }

    match /users/{uid} {
      allow read: if (isSignedIn() && uid == request.auth.uid)
        || (isSignedIn() && resource.data.email == request.auth.token.email)
        || (isStaff() && resource.data.gymId == gymId())
        || isSuperAdmin();

      allow create: if false;

      allow update: if (
          isSignedIn()
          && uid == request.auth.uid
          && sameGymExisting()
          && request.resource.data.role == resource.data.role
          && request.resource.data.gymId == resource.data.gymId
        ) || (isGymAdmin() && sameGymExisting());

      allow delete: if false;
    }

    match /plans/{id} {
      allow read: if isSignedIn() && sameGymExisting();
      allow create, update, delete: if isGymAdmin() && sameGym(request.resource.data);
    }

    match /subscriptions/{id} {
      allow read: if isSignedIn()
        && sameGymExisting()
        && resource.data.userId == request.auth.uid;

      allow read: if isStaff() && sameGymExisting();

      // ✅ SUPER_ADMIN now passes sameGym(...) via helper
      allow create, update: if isStaff() && sameGym(request.resource.data);
      allow delete: if isGymAdmin() && sameGymExisting();
    }

    // Superadmin payment tracking
    match /gymPayments/{id} {
      allow read: if isSuperAdmin();
      allow create, update: if isSuperAdmin();
      allow delete: if false;
    }

    match /products/{id} {
      allow read: if isSignedIn() && sameGymExisting();
      allow create, update, delete: if isGymAdmin() && sameGym(request.resource.data);
    }

    match /orders/{id} {
      allow read: if isSignedIn()
        && sameGymExisting()
        && resource.data.userId == request.auth.uid;

      allow read: if isStaff() && sameGymExisting();

      allow create: if isSignedIn()
        && hasUserDoc()
        && (isSuperAdmin() || request.resource.data.gymId == gymId())
        && request.resource.data.userId == request.auth.uid;

      allow update, delete: if false;
    }

    match /smsLogs/{id} {
      allow read: if isStaff() && sameGymExisting();
      allow write: if false;
    }

    match /balanceTransactions/{id} {
      allow read: if isSignedIn()
        && (isSuperAdmin()
          || isSuperAdminToken()
          || resource.data.gymId == gymId()
          || resource.data.gymId == resolvedGymId());
      allow write: if false;
    }
  }
}
